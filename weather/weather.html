<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../res/css/lib/jquerym.min.css" />
    <script src="../res/js/lib/jquery.min.js"></script>
    <script src="../res/js/lib/jqery-mobile.min.js"></script>
    <script src="../res/js/lib/chart.min.js"></script>
    <script src="./Vibrant.js"></script>
    <style>
        html,
        body {
            height: 100%;
        }
    </style>
</head>

<body >
    <div data-transition='slide' id="weather" data-role="page" data-title="weather visualizer" style="background-repeat: no-repeat; background-size: auto; -webkit-background-size: cover;-moz-background-size: cover;-o-background-size: cover;background-size: cover;">
        <div id='header' data-role="header">
            <h1 style="white-space: normal !important; margin: 0 !important; padding-right: 10px; padding-left: 10px;">
                <span id='weatherin'></span> - Weather</h1>
        </div>

        <div id='bd' data-role="content" style="padding: 0; padding-top: 16px; height: 100%;">
            <div class="search" style="padding-right: 16px; padding-left: 16px;">
                <input type="text" placeholder="Search" id="searchbar" name="search" />
            </div>

            <div class='results' style="padding-top: 16px; padding-right: 16px; padding-left: 16px;">
                <img id='icon' src='./images/icons/day/clear.png' width="110" height="110" style="float: left;" />

                <div style="float: right; text-align: right;">
                    <span style="display: block; font-size: 25px;" id="description">Clear sky</span>
                    <span style="font-size: 60px;">
                        <span id="temp"></span>
                        <sup id="extra" style="font-size: 20px;">Â°C</sup>
                    </span>
                </div>
            </div>

            <div id="chart" style="padding-right: 16px; padding-left: 16px; margin-top: 140px; background-color: rgba(255, 255, 255, 0.5);">
                <canvas id="weatherchart" width="200" height="140"></canvas>
            </div>
        </div>
    </div>
    <div data-transition='slide' data-role='page' data-title="weather-compare" id='compare' >
        <div id='cheader' data-role="header">
            <h1 style="white-space: normal !important; margin: 0 !important; padding-right: 10px; padding-left: 10px;">
                <span id='compare'></span>Compare Weather</h1>
        </div>
        <div id='bd' data-role="content" style="padding: 0; padding-top: 16px; height: 100%;">
            <div class="search" style="padding-right: 16px; padding-left: 16px;">
                <input type="text" placeholder="Location 1" id="searchbar1" name="search" />
                <input type="text" placeholder="Location 2" id="searchbar2" name="search" />
                <input type="text" placeholder="Location 3" id="searchbar2" name="search" />
            </div>

    </div>

    <script>
        function intiMap() { } // global declaration because google maps js script looks for initMap() before document is ready


        $(document).ready(function () {
            // Add an action for handling page swipes
            // console.log('hello', $.mobile.defaultTransitionHandler('slide') );
            $("body").on("swipeleft swiperight", function (e) {
                // Grab the current page id and swipe direction
                var curPage = $.mobile.activePage[0].id;
                var direction = e.type.replace('swipe', '');
                console.log();
                console.log(curPage, direction);
                console.log();

                // Check if the page is on home and is swiping left
                if (curPage == "weather" && direction == "left") {
                    // Change the page to page 2
                    $.mobile.navigate("#compare");
                    $('#searchbar1').val($('#searchbar').val());
                }
                if(curPage =='compare' && direction=='right'){
                    $.mobile.navigate('#weather');
                }
            });
            // geolocation
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition((location) => {
                    console.log(location);
                    // $('searchbar').text(location.city.coord.name+', '+location.city.coord.country);
                    loadWeather(location.coords.latitude, location.coords.longitude);
                });
            }

            function updateColors() {
                $('#bd, #header').css('color', 'white');
            }

            var lat;
            var long;
            // writing the actul function
            initMap = function () {
                updateColors();
                var autocomplete = new google.maps.places.Autocomplete(document.getElementById('searchbar'));
                google.maps.event.addListener(autocomplete, 'place_changed', () => {
                    lat = autocomplete.getPlace().geometry.location.lat();
                    long = autocomplete.getPlace().geometry.location.lng();
                    loadWeather(lat, long);
                });
            }

            var weatherImagesIcons = {
                'clouds': ['cloud.png', 'few_clouds.png'],
                'extreme': ['clear.png', 'clear.png'],
                'clear sky': ['clear.png', 'clear.png'],
                'few clouds': ['cloud.png', 'few_clouds.png'],
                'scattered clouds': ['cloud.png', 'few_clouds.png'],
                'overcast clouds': ['cloud.png', 'few_clouds.png'],
                'broken clouds': ['cloud.png', 'few_clouds.png'],
                'shower rain': ['rain.png', 'rain.png'],
                'light rain': ['rain.png', 'rain.png'],
                'rain': ['rain.png', 'rain.png'],
                'thunderstorm': ['rain.png', 'storm.png'],
                'snow': ['snow.png', 'snow.png'],
                'mist': ['cloud.png', 'mist.png']
            }

            function loadWeather(lat, long) {
                $.getJSON('http://api.openweathermap.org/data/2.5/weather?lat=' + lat + '&lon=' + long + '&appid=337f84fa35fa79d1a7e6bdfa3a1003ac&units=metric', {}, function (data) {
                    console.log(data);
                    if ($('#searchbar').val() == '') {
                        $('#searchbar').val(data.name + ', ' + data.sys.country);
                    }

                    $('#weatherin').text($('#searchbar').val());

                    var description = data['weather'][0]['description'].toString();
                    $('#description').text(description[0].toUpperCase() + description.slice(1));
                    $('#temp').text(data['main']['temp']);
                    var iconid = data['weather'][0]['icon'];
                    var img = document.createElement('img');

                    if (iconid[iconid.length - 1] == 'd') {
                        try {
                            $('#weather').css('background-image', 'url("./images/backgrounds/day/' + weatherImagesIcons[data['weather'][0]['description']][0] + '")');
                            $('#icon').attr('src', './images/icons/day/' + weatherImagesIcons[data['weather'][0]['description']][1]);
                            img.setAttribute('src', "./images/backgrounds/day/" + weatherImagesIcons[data['weather'][0]['description']][0]);
                        } catch (e) {
                            $('#weather').css('background-image', 'url("./images/backgrounds/day/clear.png")');
                            $('#icon').attr('src', './images/icons/day/clear.png');
                            img.setAttribute('src', "./images/backgrounds/day/clear.png");
                        }
                    } else {
                        try {
                            $('#weather').css('background-image', 'url("./images/backgrounds/night/' + weatherImagesIcons[data['weather'][0]['description']][0] + '")');
                            $('#icon').attr('src', './images/icons/night/' + weatherImagesIcons[data['weather'][0]['description']][1]);
                            img.setAttribute('src', "./images/backgrounds/night/" + weatherImagesIcons[data['weather'][0]['description']][0]);
                        } catch (e) {
                            $('#weather').css('background-image', 'url("./images/backgrounds/night/clear.png")');
                            $('#icon').attr('src', './images/icons/night/clear.png');
                            img.setAttribute('src', "./images/backgrounds/day/clear.png");
                        }
                    }

                    img.addEventListener('load', function () {
                        var vibrant = new Vibrant(img);
                        var swatches = vibrant.swatches();
                        console.log(swatches);
                        // $('#chart').css('background-color', swatches['Vibrant'].getHex());
                        $('#header').css('background-color', swatches['Vibrant'].getHex());
                        $('#compare').css('background-color', swatches['Vibrant'].getHex());
                        $('#cheader').css('background-color', swatches['Vibrant'].getHex());
                    });
                    loadChart(lat, long);
                });
            }

            function loadChart(lat, long) {
                // $('#chart').css('background-color', 'white')
                $.getJSON('http://api.openweathermap.org/data/2.5/forecast?lat=' + lat + '&lon=' + long + '&appid=337f84fa35fa79d1a7e6bdfa3a1003ac&units=metric', {}, function (data) {
                    console.log(data);
                    var wholedata = data.list;
                    var fivedaydata = [];
                    var comingweek = [];
                    for (i = 4; i < data.cnt; i += 8) {
                        // console.lof(i)
                        console.log(data.list[i].main.temp)
                        fivedaydata.push(data.list[i].main.temp);
                    }

                    var ctx = document.getElementById('weatherchart').getContext('2d');
                    var chart = new Chart(ctx, {
                        type: 'line',
                        defaultFontColor: 'green',
                        data: {
                            labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                            datasets: [
                                {
                                    label: 'Temperature',
                                    data: fivedaydata,
                                    borderColor: 'red',
                                    fill: false
                                }]
                        },
                        options: {
                            scales: {
                                xAxes: {
                                    gridLines: {
                                        gridColor: '#fff'
                                    }
                                },
                                yAxes: {
                                    gridLines: {
                                        gridColor: '#fff'
                                    }
                                }
                            }
                        }
                    });
                });
            }


        });


    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXHwslEixns_oNow3E5BBbnF0l4qjJnqY&libraries=places&callback=initMap"
        async defer></script>

</body>

</html>